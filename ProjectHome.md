我的新作：细菌英雄（Super Germ）已登陆appStore：https://itunes.apple.com/us/app/super-germ/id655390338?ls=1&mt=8
![http://recombination-3d-3-maze.googlecode.com/files/psb.png](http://recombination-3d-3-maze.googlecode.com/files/psb.png)

---

此页面已作废！
**《重组3D IV：梁上菌子》见：**
http://code.google.com/p/recombination-3d-4-on-the-beam/

---



《重组3D Ⅲ：迷宫》

一个以细菌为主角第三人称3d射击小游戏。

实现了：室内和室外场景（室外为quadtree+lod及分块调度，室内为bsp+portal），动态阴影（采用 shadow volume（z-pass + z-fail）），3d音效（openal），骨骼动画 等。


开发工具：vc6.0（后换作vc2010），opengl，openal，fbx sdk

日志：http://user.qzone.qq.com/350479720/blog/1311966023


**程序在不断更新中，最上面的是最新版本，最上面的截图是最新版本截图**

---

16.0(更正)版改进：

**（1）修正了当直接及运行反射球同时都能看到爆炸时，爆炸发生闪烁的问题。**

（2）将渲染部分中一些代码转移到了逻辑部分。

（3）删除了一些垃圾代码。

刚才发完16.0版5分钟，忽然发现一处疏忽，只好改过重发一遍。

---

15.9版改进：

**（1）修正了在非vbo模式下崩溃的问题（有待在不支持vbo的系统上做进一步测试）。**

**（2）将vbo缓冲数组由vector改为c数组，更快。**

（3）将某些数组拷贝由for循环改为memcpy，更快。

（4）openal初始化使用了更官方的函数。

---

15.8版改进：

**（1）实现了反射球效果(sphere mapping)。**

**（2）使用了材质，使某些物体呈现出高光。**

（3）修正了粒子重新初始化时未将尺寸复位的疏漏。

（4）更多地方使用了vbo。

（5）将所有资源都移到了data文件夹中，这样看起来更干净。

---

15.2(fix)版改进：

**（1）修正在某些视角下出现墙壁缺失的严重bug。**

这个bug从10.4版就开始出现了（过了这么久才发现，汗），是在由vc6.0迁移到vc2010过程中产生的（两编译器浮点数精度处理上有差别）。此bug根本原因是在建立bsp树和自动生成portal过程中使用了近似计算。现已替换为精确计算，bug消除。提醒自己：在使用近似计算的时一定要小心，分清场合，不要因为追求效率造成错误。

![http://recombination-3d-3-maze.googlecode.com/files/15.2bug_and_fix.png](http://recombination-3d-3-maze.googlecode.com/files/15.2bug_and_fix.png)

---

15.2版改进：

**（1）将地形的部分绘制由glBegin/glEnd模式改为了VBO。**

**（2）对地形预生成normalmap，省去了实时计算法向的开销。**

（3）将2的n次幂的计算改用位运算。

（4）对封闭的模型进行了背面剔除。

目前对VBO初接触，所以只是先试探性地将一小部分绘制替换成了VBO（如果系统不支持VBO则转用顶点数组（VA）），在今后的版本中会逐渐作更彻底地替换。


---

15.0版改进：

**（1）实现了多张贴图的fbx模型显示，同时修正了前一版贴图部分的一个bug。**

**（2）实现对fbx模型subMesh进行预划分，纹理坐标进行预取，使多张贴图与单一贴图具有相同效率。**

（3）在场景中央添加了一个动画人物（多张贴图），为配合人物添加了一段音乐。

在（2）的实现过程中，用到了向fbx节点添加userData，这个功能很强大。

---

14.0版改进：

（1）模型动画文件改用FBX格式，取代之前用的.x文件。

这个意义挺大的，将来使用模型就更方便了。暂时只是放了个恐龙（代替以前的tiny哥）。等将来找到更多的资源，再加进来。

另外，由于vc6.0不支持fbx sdk，所以这一版本开始以后就只是vc2010了。

---

10.4版改进：

（1）加强了portal生成中的计算精度，调低了地形的分辨率。

（2）修改了菜单勾选。

（3）删除了一处被执行又无实际效果的垃圾代码。

注：10.4版我上传了两个：一个是10.4 (vc6)版，一个是10.4 (vc2010)版。之前程序一直都是在vc6中写的，vc2010版是近日刚转化过来的。目前我感觉vc2010版本运行起来没有vc6版本流畅，不过，转向vc2010是势在必行的。以后随着我对vc2010的不断熟悉，会尽力做些优化。

---

10.3版改进：

（1）对导弹爆炸的粒子效果进行了强力优化，现在随意发射导弹都能保持流畅了。

---

10.2版改进：

（1）简化了场景树的操作，着重优化了坐标转化、定位操作以及旋转操作。

（2）将建筑数据由以前直接写在代码里改为由文件读取，提高了编译速度和灵活性。

（3）将以前实时由硬盘读取地形数据改为先全部预读取至内存，提高了地形渲染效率。

（4）消除了拱门阴影闪烁的问题。

---

10.0版改进：

（1）对纹理管理作了一下封装，并补作了一些清理。

（2）出于安全性的考虑，将myvector::grow()以前用push\_back实现改为用resize实现。

现在主要在做实验室项目，只是偶尔想到本程序中某些实现不太恰当的地方小改一下。等实验室项目做完，再回来进行大改。

---

9.9版改进：

（1）修补了“有些物体作了可见性检测但未进行剔除”的疏漏。

---

9.8版改进：

**（1）实现了带有蒙皮动画的x文件(tiny.x)的解析和播放。**

**（2）实现了tiny的网络简化（边收缩算法），从而自动生成人物的多级LOD。**

（3）修正了向量数乘（mul函数)实现中的一个bug。

（4）修正了游戏结束后窗口停止刷新的毛病，另外限制了窗口尺寸。

---

10.0版改进：

（1）对纹理管理作了一下封装，并补作了一些清理。

（2）出于安全性的考虑，将myvector::grow()以前用push\_back实现改为用resize实现。

现在主要在做实验室项目，只是偶尔想到本程序中某些实现不太恰当的地方小改一下。等实验室项目做完，再回来进行大改。

---

9.5版改进：

（1）优化了逆矩阵的计算。

矩阵求逆在程序中用得较少，所以优化效果不明显，但勿以善小而不为吧。

---

9.4版改进：

（1）排除了地形的一个溢出隐患。

（2）优化了矩阵变换。

由于隐患已排除，所以现在看来win32版本已全面好于mfc版本，所以以后无特殊情况就沿用win32框架了。

---

9.3 (win32版) 改进：

（1）补充了一处音效。

---

9.2 (win32版) 改进：

**（1）加入了3d音效（openal）。**

（2）优化了粒子爆炸的执行效率。

**（3）修补了一个可能导致在某些系统上无法正常显示阴影的配置bug。**

**注：之前的版本用的都是mfc框架，本版为使用win32框架的第一个版本，至于最终是否彻底转到win32，还是继续留在mfc，有待进一步考虑。**

---

8.3版改进：

**（1）修正了程序运行一段时间后敌人消失及程序速度下降的bug。**

（2）加强了可见性检测。

---

8.2版改进：

**（1）增加了矩阵防蠕变措施。解决了以前版本中运行一段时间后院落中央的"超级基因"萎缩的bug。**

**（2）在屋顶上建了一个水池，里面放了一条金鱼（手工实现的骨骼动画）。**

（3）优化了水面的绘制速度。


---

8.1版改进：

**（1）实现了阴影随距离变远而变淡（同时克服了阴影z-fighting问题）**。

（2）为拱门添加了阴影。

（3）解决了远处的建筑被天空球裁切的问题。

---

7.8版改进：

**（1）修正了portal自动生成中的一个重要逻辑错误。**

**（2）完善了bsp+portal机制，使其能支持斜墙面。**

（3）通过两遍绘制，解决了当细菌远离建筑时阴影消失的问题。

---


7.5版改进：

（1）解决了debug下运行出错的问题（同时消除了release下的隐患）。

**7.5版about对话框中的日期写错了，应该是2012-1-14，写成2011了--!**

---

7.4版改进：

（1）加入了发射导弹和爆炸效果（按S键发射）。

（2）修改了油管火焰效果。

（3）通过alpha混合在一定程度上克服了阴影的z-fighting现象。

**7.4版演示视频：http://player.youku.com/player.php/sid/XMzM3NTg1NDQ4/v.swf**

---

7.3版改进：

（1）排除了一处可能导致轻微内存泄露的隐患。

---

7.2版改进：

（1）增加了油罐，射击可以引燃。

（2）优化了平方倒数和三角函数的计算。

（3）优化了粒子的实现，实现粒子的回收重用。

---

7.1版改进：

（1）改正了一处文字错误。

---

7.0版改进：

**（1）实现了建筑阴影（shadow volume, z-fail）**

（2）删除元素改用列表紧缩法

（3）优化了基本几何体的绘制

建筑阴影可以通过 菜单->开关->阴影 打开或关闭。

注：由于pvs模式下的阴影还没有添加，暂时屏蔽了pvs模式。

---

6.3版改进：

**（1）加入了中文字体。**

（2）缩减了说明文件的大小。

**6.3版演示视频：http://v.youku.com/v_show/id_XMjk4NjQ5MzEy.html**

---

6.2版改进：

（1）修正了“场景管理”菜单失效的问题。

> （在6.0和6.1版中由于修改了别的地方，导致菜单失效，然后没有做回归测试）。

---

6.1版改进：

**（1）修正了一个导致“越运行越慢”的致命bug**

> （由于细菌与墙壁的碰撞忘了作可视性剔除）。

（2）修正了室内跳跃时偶尔会穿墙的bug。

---

6.0版改进：

这一版两个最大的改进是：实现在由墙头的自然跌落和每秒25帧(以前的版本每秒只有10帧)。

（1）实现了主角自墙头的自然下落(无需跳跃了)。

（1）重写了地形剔除算法。

（2）修正了一个可能导致内存泄露的潜在隐患。

（3）对碰撞检测作了很强力的优化。

（4）对碰撞检测作了可见性剔除（只对可见的物体进行碰撞检测，此为一欺骗）。

---

5.1版改进：

（1）彻底修改了以前的入口递归实现方法，效率至少提高10倍。

（2）彻底修改了pvs生成方法，生成时间从以前的无法忍受缩短到2至3分钟。

以前版本中的递归方法走入了误区，从这一版开始才终于跳出了这个误区.

---

4.3版改进：

（1）对入口递归加入了剪枝，使运行速度有所提高。

（2）调整了参数，杜绝了pvs模式下丢失三角面的状况。

---

4.2版改进：

此版本是自1.0版以来首次增加可以看得见的新功能。

（1）修正了3.0版中计算PVS时犯的一个严重逻辑错误。

（2）实现了台阶，为迷宫加了第二层，主角可以上楼了。

---

3.0版改进：

（1）实现了预计算潜在可视集PVS（由于pvs占用较多内存，设计在开始前由用户通过输入决定是否采用）。

（2）添加了“场景管理”菜单，设置了"bsp+pvs","bsp+portal(节点级)"和"bsp+portal(三角面级)"三种模式，可以切换对比运行速度。

（3）修正了以前当相机在墙体内时可能丢失三角面的缺陷。

（4）将地形高度图文件由以前的24位bmp改为单道的纯数据文件，压缩了数据量，提高了地形块的实时加载速度。

（5）在不影响显示的前提下，将以前一些256\*256的贴图图片改为小尺寸。

（6）对室内碰撞检测，多边形切割等重点函数进行了优化，对一些重要的循环进行了优化。

（7）去掉了不必要的状态提示文字，将状态的选择从菜单项中体现。

---

2.2版改进：

（1）作了一些代码级的优化，运行速度有所提高。

（2）排除了一些细小的隐患。

---

2.0版改进：

（1）1.0版在bsp树平衡性上存在严重失误，导致碰撞检测效率低下。此处已经修正。


---

截图：

![http://recombination-3d-3-maze.googlecode.com/files/r15.8_1.png](http://recombination-3d-3-maze.googlecode.com/files/r15.8_1.png)

![http://recombination-3d-3-maze.googlecode.com/files/r15.8_2.png](http://recombination-3d-3-maze.googlecode.com/files/r15.8_2.png)

![http://recombination-3d-3-maze.googlecode.com/files/r15.8_f1.png](http://recombination-3d-3-maze.googlecode.com/files/r15.8_f1.png)

![http://recombination-3d-3-maze.googlecode.com/files/r_15.png](http://recombination-3d-3-maze.googlecode.com/files/r_15.png)

![http://recombination-3d-3-maze.googlecode.com/files/r15_2.png](http://recombination-3d-3-maze.googlecode.com/files/r15_2.png)

![https://recombination-3d-3-maze.googlecode.com/files/r8.2_1.jpg](https://recombination-3d-3-maze.googlecode.com/files/r8.2_1.jpg)

![http://recombination-3d-3-maze.googlecode.com/files/r8.1_1.jpg](http://recombination-3d-3-maze.googlecode.com/files/r8.1_1.jpg)

![http://recombination-3d-3-maze.googlecode.com/files/r8.1_2.jpg](http://recombination-3d-3-maze.googlecode.com/files/r8.1_2.jpg)

![http://recombination-3d-3-maze.googlecode.com/files/r8.1_rulePic2.jpg](http://recombination-3d-3-maze.googlecode.com/files/r8.1_rulePic2.jpg)

![http://recombination-3d-3-maze.googlecode.com/files/r_7.4_3__.jpg](http://recombination-3d-3-maze.googlecode.com/files/r_7.4_3__.jpg)

![http://recombination-3d-3-maze.googlecode.com/files/r_7.4_2__.jpg](http://recombination-3d-3-maze.googlecode.com/files/r_7.4_2__.jpg)

![http://recombination-3d-3-maze.googlecode.com/files/r_7.4_1__.jpg](http://recombination-3d-3-maze.googlecode.com/files/r_7.4_1__.jpg)